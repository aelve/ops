---

# Set up a load balancer and SSL terminator. All our domains should point
# there and then traffic would be rerouted to the right machines.

# When adding a domain, don't forget to update both balancer_vhosts and
# certbot_certs.

# To certbot_certs's domains add server_name.

# More info at playbook/roles/holms.balancer/defaults/main.yml

- hosts: terminator
  tasks:

    - include_role:
        name: holms.balancer
      vars:
        balancer_vhosts:
          - name: codesearch
            upstreams: [ 's1.codesearch.aelve.com' ]
            server_name: "codesearch.aelve.com"

          - name: codesearch-portainer
            upstreams: [ 's1.codesearch.aelve.com:{{ codesearch_portainer_port }}' ]
            server_name: "codesearch.aelve.com"
            server_port: "{{ codesearch_portainer_port }}"

          - name: codesearch-staging
            upstreams: [ 's1.staging.codesearch.aelve.com' ]
            server_name: "staging.codesearch.aelve.com"

          - name: codesearch-staging-portainer
            upstreams: [ 's1.staging.codesearch.aelve.com:{{ codesearch_portainer_port }}' ]
            server_name: "staging.codesearch.aelve.com"
            server_port: "{{ codesearch_portainer_port }}"

          - name: guide-main
            upstreams: [ 's1.staging.guide.aelve.com:{{ guide_main_port }}' ]
            server_name: "staging.guide.aelve.com"

          - name: guide-main-port
            upstreams: [ 's1.staging.guide.aelve.com:{{ guide_main_port }}' ]
            server_name: "staging.guide.aelve.com"
            server_port: "{{ guide_main_port }}"

          - name: guide-api
            server_port: "{{ guide_api_port }}"
            upstreams: [ 's1.staging.guide.aelve.com:{{ guide_api_port }}' ]
            server_name: "staging.guide.aelve.com"

          - name: guide-ekg
            upstreams: [ 's1.staging.guide.aelve.com:{{ guide_ekg_port }}' ]
            server_name: "staging.guide.aelve.com"
            server_port: "{{ guide_ekg_port }}"

    - include_role:
        name: geerlingguy.certbot
      vars:
        certbot_admin_email: yom@artyom.me
        certbot_certs:
          - domains:
              - staging.guide.aelve.com
          - domains:
              - codesearch.aelve.com
          - domains:
              - staging.codesearch.aelve.com
